licenses(["notice"])  # Apache 2

package(default_visibility = ["//visibility:public"])

config_setting(
    name = "windows_x86_64",
    values = {"cpu": "x64_windows"},
)

cc_library(
    name = "luajit",
    srcs = select({
        ":windows_x86_64": ["thirdparty_build/lib/luajit.lib"],
        "//conditions:default": ["thirdparty_build/lib/libluajit-5.1.a"],
    }),
    hdrs = glob(["thirdparty_build/include/luajit-2.1/*"]),
    includes = ["thirdparty_build/include"],
    # TODO(mattklein123): We should strip luajit-2.1 here for consumers. However, if we do that
    # the headers get included using -I vs. -isystem which then causes old-style-cast warnings.
)

cc_library(
    name = "tcmalloc_and_profiler",
    srcs = ["thirdparty_build/lib/libtcmalloc_and_profiler.a"],
    hdrs = glob(["thirdparty_build/include/gperftools/**/*.h"]),
    strip_include_prefix = "thirdparty_build/include",
)

cc_library(
    name = "tcmalloc_debug",
    srcs = ["thirdparty_build/lib/libtcmalloc_debug.a"],
    hdrs = glob(["thirdparty_build/include/gperftools/**/*.h"]),
    strip_include_prefix = "thirdparty_build/include",
)

cc_library(
    name = "wavm_with_llvm",
    srcs = select({
        ":windows_x86_64": ["WINDOWS_IS_NOT_SUPPORTED_YET"],
        "//conditions:default": [
            # ld: Runtime and WASTParse need to be listed first.
            "thirdparty_build/lib/WAVM/RelWithDebInfo/libRuntime.a",
            "thirdparty_build/lib/WAVM/RelWithDebInfo/libWASTParse.a",
            "thirdparty_build/lib/WAVM/RelWithDebInfo/libEmscripten.a",
            "thirdparty_build/lib/WAVM/RelWithDebInfo/libIR.a",
            "thirdparty_build/lib/WAVM/RelWithDebInfo/libLLVMJIT.a",
            "thirdparty_build/lib/WAVM/RelWithDebInfo/libLogging.a",
            "thirdparty_build/lib/WAVM/RelWithDebInfo/libNFA.a",
            "thirdparty_build/lib/WAVM/RelWithDebInfo/libPlatform.a",
            "thirdparty_build/lib/WAVM/RelWithDebInfo/libRegExp.a",
            "thirdparty_build/lib/WAVM/RelWithDebInfo/libThreadTest.a",
            "thirdparty_build/lib/WAVM/RelWithDebInfo/libWASM.a",
            "thirdparty_build/lib/WAVM/RelWithDebInfo/libWASTPrint.a",
            "thirdparty_build/lib/WAVM/libWAVMUnwind.a",
        ] + [
            # ld: listed in order from llvm-config --libnames.
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMLTO.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMPasses.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMObjCARCOpts.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMMIRParser.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMSymbolize.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMDebugInfoPDB.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMDebugInfoDWARF.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMCoverage.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMTableGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMDlltoolDriver.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMOrcJIT.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMXCoreDisassembler.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMXCoreCodeGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMXCoreDesc.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMXCoreInfo.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMXCoreAsmPrinter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMSystemZDisassembler.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMSystemZCodeGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMSystemZAsmParser.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMSystemZDesc.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMSystemZInfo.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMSystemZAsmPrinter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMSparcDisassembler.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMSparcCodeGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMSparcAsmParser.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMSparcDesc.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMSparcInfo.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMSparcAsmPrinter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMPowerPCDisassembler.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMPowerPCCodeGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMPowerPCAsmParser.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMPowerPCDesc.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMPowerPCInfo.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMPowerPCAsmPrinter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMNVPTXCodeGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMNVPTXDesc.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMNVPTXInfo.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMNVPTXAsmPrinter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMMSP430CodeGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMMSP430Desc.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMMSP430Info.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMMSP430AsmPrinter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMMipsDisassembler.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMMipsCodeGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMMipsAsmParser.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMMipsDesc.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMMipsInfo.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMMipsAsmPrinter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMLanaiDisassembler.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMLanaiCodeGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMLanaiAsmParser.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMLanaiDesc.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMLanaiAsmPrinter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMLanaiInfo.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMHexagonDisassembler.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMHexagonCodeGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMHexagonAsmParser.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMHexagonDesc.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMHexagonInfo.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMBPFDisassembler.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMBPFCodeGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMBPFAsmParser.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMBPFDesc.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMBPFInfo.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMBPFAsmPrinter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMARMDisassembler.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMARMCodeGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMARMAsmParser.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMARMDesc.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMARMInfo.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMARMAsmPrinter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMARMUtils.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAMDGPUDisassembler.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAMDGPUCodeGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAMDGPUAsmParser.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAMDGPUDesc.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAMDGPUInfo.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAMDGPUAsmPrinter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAMDGPUUtils.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAArch64Disassembler.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAArch64CodeGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAArch64AsmParser.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAArch64Desc.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAArch64Info.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAArch64AsmPrinter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAArch64Utils.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMObjectYAML.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMLibDriver.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMOption.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMWindowsManifest.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMFuzzMutate.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMX86Disassembler.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMX86AsmParser.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMX86CodeGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMGlobalISel.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMSelectionDAG.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAsmPrinter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMDebugInfoCodeView.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMDebugInfoMSF.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMX86Desc.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMMCDisassembler.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMX86Info.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMX86AsmPrinter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMX86Utils.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMMCJIT.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMLineEditor.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMInterpreter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMExecutionEngine.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMRuntimeDyld.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMCodeGen.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMTarget.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMCoroutines.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMipo.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMInstrumentation.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMVectorize.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMScalarOpts.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMLinker.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMIRReader.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAsmParser.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMInstCombine.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMTransformUtils.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMBitWriter.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMAnalysis.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMProfileData.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMObject.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMMCParser.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMMC.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMBitReader.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMCore.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMBinaryFormat.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMSupport.a",
            "thirdparty_build/lib/llvm-6.0/lib/libLLVMDemangle.a",
        ],
    }),
    hdrs = glob([
        "thirdparty_build/include/WAVM/**/*.h",
        "thirdparty_build/include/llvm-6.0/llvm/**/*.def",
        "thirdparty_build/include/llvm-6.0/llvm/**/*.h",
    ]) + [
        # WAVM includes "xxhash.c" to inline all the functions.
        "thirdparty_build/include/WAVM/Inline/xxhash/xxhash.c",
    ],
    includes = [
        "thirdparty_build/include",
        "thirdparty_build/include/llvm-6.0",
    ],
    linkopts = select({
        "@bazel_tools//tools/osx:darwin": [
            "-lcurses",
            "-lm",
        ],
        "//conditions:default": [
            "-lm",
        ],
    }),
    deps = ["//external:zlib"],
)
